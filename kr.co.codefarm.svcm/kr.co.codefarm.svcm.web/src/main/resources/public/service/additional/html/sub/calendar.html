<!-- <link rel="stylesheet" type="text/css" href="/app/design/assets/css/counseling.css"> -->
<link rel="stylesheet" type="text/css" href="/assets/css/tui/tui-time-picker.css">
<link rel="stylesheet" type="text/css" href="/assets/css/tui/tui-date-picker.css">
<link rel="stylesheet" type="text/css" href="/assets/css/tui/tui-calendar.css">
<!-- <link rel="stylesheet" type="text/css" href="/assets/css/tui/tui-default.css"> -->

<script type="text/javascript" src="/assets/js/vendor/chance.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/tui/tui-code-snippet.js"></script>
<script type="text/javascript" src="/assets/js/vendor/tui/tui-time-picker.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/tui/tui-date-picker.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/tui/tui-calendar.js"></script>

<h2 id="top">일정 관리</h2>
<section class="sub_cont_box" id="app">
	<section class="cont_box">
		<!-- <h3 class="h3" @click="cal.prev()">일정관리</h3> -->
		<div id="menu" class="calendar-top">
			<select id="viewTypeGb" class="size-m btn-viewtype" @change="viewTypeChange" v-if="tabNo=='1'">
				<option value="month">Month</option>
				<option value="week">Weekly</option>
				<option value="day">Daily</option>
			</select> <span id="renderRange" class="render-range"></span>
			<div class="move-day-group">
				<a href="#!" class="move-day-prev" @click="setChangeRange('prev')"><span class="icon-chevron-left"></span></a> <a href="#!" class="move-day-next" @click="setChangeRange('next')"><span class="icon-chevron-right"></span></a>
			</div>
			<a href="#!" class="btn-today" @click="setChangeRange('today')">오늘</a>
		</div>
		<div class="tab-outter">
			<div class="tab-type04">
				<div class="tab-inner">
					<div rel="tab1">
						<a href="#!" class="active" @click="tabNo='1';">일정관리</a>
					</div>
					<div rel="tab2">
						<a href="#!" @click="tabNo='2'; calendarList.addRow();">캘린더추가</a>
					</div>
				</div>
			</div>
		</div>
		<div class="tab-container">
			<div id="tab1" class="tab-content">
				<div class="row form-row board">
					<div class="form-group col s12 l9 xl10">
						<div id="calendar" style="height: 730px;"></div>
					</div>
					<div class="form-group col s12 l3 xl2">
						<div id="lnb-calendars" class="lnb-calendars">
							<div class="lnb-calendars-viewall">
								<div class="lnb-calendars-item">
									<div class="checkbox type02">
										<input class="tui-full-calendar-checkbox-square" type="checkbox" id="checkViewAll" value="all" checked> <label for="checkViewAll">View All</label> <i class="icon-check"></i>
									</div>
								</div>
							</div>
							<div id="calendarList" class="lnb-calendars-d1"></div>
						</div>
						<div id="calendarTypeName" class="lnb-calendars-d1" style="display: none;"></div>
						<div id="calendarTypeIcon" class="lnb-calendars-d1"></div>
					</div>
				</div>
			</div>
			<div id="tab2" class="tab-content">

				<div class="row form-row board" v-if="calendarList.currentRow">
					<div class="form-group col s12 l3 calendar-add-list">   
						<table class="table-type04">
							<colgroup>
								<col width="80%" />
								<col />
							</colgroup>
							<tbody>
								<tr v-for="(item, index) in calendarList.data" v-if="MNG_YN=='Y' || (calendarList.getRowType(index) != '8'&&item.BONIN_YN!='N')" @click="calendarList.selectRow(index);">
									<td>{{item.CAL_NM}}</td>
									<td><font :color="item.CAL_COLOR">■</font></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="form-group col s12 l9 calendar-add-detail">
						<form>
							<div class="calendar-add-wrap">
								<div class="form-group col s12">
									<label for="calNm" class="label-type01 required">캘린더명</label> <input type="text" id="calNm" class="size-m" name="calNm" data-vv-as="캘린더명" v-model="calendarList.currentRow.CAL_NM" v-validate="'required|max:300'" v-bind:class="{'invalid': errors.has('calNm')}" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1" /> <small class="form-txt">{{ errors.first('calNm') }}</small>
								</div>
								<div class="form-group col s12">
									<label for="calColor" class="label-type01 required">캘린더색상</label>
									<div class="form-check">
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio01" value="#9e5fff" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio01"><font color="#9e5fff">보라</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio02" value="#00a9ff" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio02"><font color="#00a9ff">파랑</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio03" value="#ff5583" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio03"><font color="#ff5583">핑크</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio04" value="#03bd9e" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio04"><font color="#03bd9e">녹색</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio05" value="#bbdc00" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio05"><font color="#bbdc00">연두</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio06" value="#ffbb3b" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio06"><font color="#ffbb3b">주황</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio07" value="#ff4040" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio07"><font color="#ff4040">빨강</font></label> <i class="radio-icon"></i>
										</div>
										<div class="radio size-m">
											<input type="radio" name="radio" id="radio08" value="#9d9d9d" v-model="calendarList.currentRow.CAL_COLOR" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1"> <label for="radio08"><font color="#9d9d9d">회색</font></label> <i class="radio-icon"></i>
										</div>
									</div>
								</div>
								<div class="form-group col s12">
									<div class="form-group" class="size-m">
										<label for="calDesc" class="label-type01">캘린더설명</label>
										<textarea id="calDesc" class="size-m" rows="10" name="calDesc" data-vv-as="캘린더설명" v-model="calendarList.currentRow.CAL_DESC" v-validate="'max:500'" v-bind:class="{'invalid': errors.has('calDesc')}" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1" /></textarea>
										<small class="form-txt">{{ errors.first('calDesc') }}</small>
									</div>
								</div>
								<div class="row form-row">
									<div class="form-group col s12 l6">
										<div class="col s12 l6 col-label">
											<label for="pyosiYn" class="label-type01 size-i">표시여부 </label>
										</div>
										<div class="col s12 l6">
											<label class="toggle-switch size-i"> <input type="checkbox" id="pyosiYn" name="pyosiYn" data-vv-as="표시여부" v-model="calendarList.currentRow.PYOSI_YN" true-value="Y" false-value="N" v-bind:class="{'invalid': errors.has('pyosiYn')}" :disabled="calendarList.currentRow.CAL_SEQ == 0 || calendarList.currentRow.CAL_SEQ == -1" /> <span class="slider round"></span>
											</label>
										</div>
									</div>
								</div>
							</div>
							<div class="col-inline btn-line right">
								<a href="#!" class="btn type01 size-m" @click="newCalendarRow">신규</a> <a href="#!" class="btn type01 size-m" @click="calModalEntry('ID_CAL_DELETE')" v-if="calendarList.currentRow.CAL_SEQ > 0">삭제</a> <a href="#!" class="btn type02 size-m" @click="calModalEntry('ID_CAL_SAVE')">저장</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</section>
	<modal-message :modalset="calModal" v-on:messagepoppupcallback="calModalCallback"></modal-message>
</section>

<script type="text/javascript">
/*******************************************************************************************************************************************************************
 * vue start
 ********************************************************************************************************************************************************************/
 var vm = new Vue({
    el: '#app',
    //사용할 데이터
    data: {
        cal: null,
        calendarList: new Dataset(),
        calendarArr: [],
        scheduleList: new Dataset(),
        firstSchedSearchFlag: true,                 //추후 단기간(해당 달의 +/- 1개월) 조회하는 방식으로 변경될 수 있는 경우 플래그 관련 부분 제거 필요
        userId: '',                         //must be modifying... (Login ID)
        calModal: new ModalSet('cal-modal'),		    //모달(notice 및 confirm용)
        tabNo: '1',
        MNG_YN: globalParam.MNG_YN,
        FIXED_USER_ID: globalParam.FIXED_USER_ID,
		initYn: true
    },
    //마운트 된 시점수행
    mounted: function(){
    	this.userId = (isNull(this.FIXED_USER_ID) ? this.session.USER_ID : this.FIXED_USER_ID);
        this.setCalendarList();
    },
    watch: {
		'calendarList.rowposition': {
			handler: function (val, oldVal) {
				if(this.calendarList.enableevent){
				}
			}
		}
    },
    //함수
    methods: {
        setCalendarList: function(e){
			var self = this;
			var returnVal = calendarApi.calendar(this.userId, true);
			returnVal.then(function(response){
				self.calendarList.setData(response.data);

				if(response.data.length > 0) {
					let chk = 0;

                   	for(var i = 0; i < self.calendarList.getRowCount(); i++){
                   		if(self.calendarList.getColumn(i , "BONIN_YN") == 'Y'){
                               self.calendarList.selectRow(i);
                               chk = 1;
                               break;
                   		}
                   	}

//                    	if(chk == 0){
//                    		self.newCalendarRow();   //new Row Auto Gen 필요 없을듯 2020-07-30 김성래
// 						if(self.initYn){
// 							self.setChangeRange('today');
// 							self.initYn = false;
// 						}
//                    	}

                   	self.makeCalendarArr();
                    self.setScheduleList();
				} else {
// 					self.newCalendarRow();   //new Row Auto Gen 필요 없을듯 2020-07-30 김성래
				}
			}).finally(function(e){
				cal.render();
			});
        },
        newCalendarRow: function(){
        	if(this.isListInInsertRow(this.calendarList)) return;

        	var addObj = {
                'USER_ID':  this.userId,
                'CAL_SEQ':  null,
                'CAL_NM':   '',
                'CAL_COLOR': '#9e5fff',
                'CAL_DESC': '',
                'PYOSI_YN': 'Y',
                'ALL_GONGYU_YN': 'N'
            };

            var newRowPosition = this.calendarList.addRow(addObj);
        },
        saveCalendarRow: function(){
            var validate = this.$validator.validateAll();

            var self = this;

			validate.then(function(response) {
				if(response){
					var rowposition = self.calendarList.rowposition;
					var rowType = self.calendarList.getRowType(rowposition);

					//신규
					if(rowType == ROWTYPE_INSERT){
						returnVal = calendarApi.calendarInsert(self.calendarList.currentRow, true);
					}
					//수정
					else if(rowType == ROWTYPE_UPDATE){
						returnVal = calendarApi.calendarUpdate(self.calendarList.currentRow, true);
					}else{
						//notifySubmit('info', '캘린더 저장', '저장할 내역이 없습니다.', 'icon-message');
					}

					if(!isNull(returnVal)){
						returnVal.then(function(response) {
							var data = response.data;

                            if(1 == (data._INSERT_ROW_CNT || data) && response.status == '200')  {
								self.setCalendarList();
								notifySubmit('success', '캘린더 저장', '저장이 완료되었습니다.', 'icon-save');
							}else{
								notifySubmit('warning', '캘린더저장', '저장에 실패하였습니다.', 'icon-caution');
							}

                            self.$forceUpdate();
                            cal.render();
						});
					}
				}else{
					//notifySubmit('warning', '캘린더 저장', '입력항목을 확인해주세요.', 'icon-caution');
				}
			});
        },
        deleteCalendarRow: function(){
            var row = this.calendarList.rowposition;
			var rowType = this.calendarList.getRowType(row);

            var self = this;

			if(rowType==ROWTYPE_INSERT) {
                self.calendarList.deleteRow(row);
                self.setCalendarList();
			} else {
				self.calendarList.selectRow(row);
				var returnVal = calendarApi.calendarDelete(self.calendarList.currentRow, true);
				returnVal.then(function(response) {
					if(response.status == '200'){
						self.setCalendarList();
						notifySubmit('success', '캘린더 설정 삭제', '삭제에 성공하였습니다.', 'icon-caution');
					}else{
						notifySubmit('warning', '캘린더 설정 삭제', '삭제에 실패하였습니다.', 'icon-caution');
					}

                    self.$forceUpdate();
                    cal.render();
				});
			}
		},
		isListInInsertRow: function(dataList) {
			if(isNull(dataList)) return;

			var findObj =_.filter(dataList.data, function(obj) {
				  			return  obj.ROW_TYPE == ROWTYPE_INSERT;
						});

			try {
				return findObj.length==0?false:true;
			} catch (err) {
				return '';
			}
		},
        setScheduleList: function(e){
            var pUserId = this.userId;
			var returnVal = calendarApi.event(pUserId, true);

            var self = this;

			returnVal.then(function(response){
                if(response.status == '200') {
                    self.scheduleList.setData(response.data);
                    setSchedulesMyList(self.scheduleList.data);
                }
			}).finally(function(){
				cal.render();
			});
        },
        createScheduleData: function(scheduleData){
            var self = this;
            var calendar = scheduleData.calendar || findUserCalendar(this.userId, scheduleData.calendarId);

            var pEventData = {
                'USER_ID' : this.userId,                                             //////////////////////// must be modifying
                'ILJEONG_SEQ': scheduleData.id?parseInt(scheduleData.id):null,
                'CAL_SEQ': parseInt(calendar.id),
                'ILJEONG_NM': scheduleData.title,
                'FR_DTTM': scheduleData.start.getTime(),
                'TO_DTTM': scheduleData.end.getTime(),
                'ALLDAY_YN': scheduleData.isAllDay==true?'Y':'N',
                'CAL_EVENT_DESC': '',
                'LOCATIOIN': scheduleData.location,
                'ALARM_GB': '',
                'ALARM_TM_GB': ''
            }

            returnVal = calendarApi.eventInsert(pEventData, true);

			if(!isNull(returnVal)){
				returnVal.then(function(response) {
                    if(response.status == '200' && response.data._INSERT_ROW_CNT == 1)  {
					    self.setCalendarList();
					}else{
					}
				});
			}

        },
        updateScheduleData: function(schedId, schedCalId, schedObj){
            var self = this;
            var frDttm = null;

            var pEventData = {
                'USER_ID' : this.userId,
                'ILJEONG_SEQ': parseInt(schedId),
                'CAL_SEQ': parseInt(schedCalId),
                'ILJEONG_NM': schedObj.title,
                'FR_DTTM': schedObj.start.getTime(),
                'TO_DTTM': schedObj.end.getTime(),
                'ALLDAY_YN': schedObj.isAllDay==true?'Y':'N',
                'CAL_EVENT_DESC': '',
                'LOCATIOIN': schedObj.location,
                'ALARM_GB': '',
                'ALARM_TM_GB': ''
            }

			returnVal = calendarApi.eventUpdate(pEventData, true);

			if(!isNull(returnVal)){
				returnVal.then(function(response) {
                    var data = response.data;
                     //alert(JSON.stringify(data));
                    if(response.status == '200')  {
                    	cal.updateSchedule(schedId, schedCalId, schedObj);   //move to callback

                    	self.setCalendarList();
                        notifySubmit('success', '스케줄 저장', '저장이 완료되었습니다.', 'icon-save');
					}else{
						notifySubmit('warning', '스케줄 저장', '저장에 실패하였습니다.', 'icon-caution');
					}

                    self.$forceUpdate();
                    cal.render();
				});
			}

        },
        deleteScheduleData: function(schedId, calId){
            var self = this;

            var pEventData = {
                'USER_ID' : this.userId,                                             //////////////////////// must be modifying
                'ILJEONG_SEQ': schedId
            }

            var returnVal = calendarApi.eventDelete(pEventData, true);
			returnVal.then(function(response) {
				if(response.status == '200'){
		            cal.deleteSchedule(schedId, calId);   //move to callback
		            self.setCalendarList();
				}else{
					notifySubmit('warning', '스케줄 삭제', '삭제에 실패하였습니다.', 'icon-caution');
				}
			});
		},
        viewTypeChange: function(){
            var pViewTypeGb = $('#viewTypeGb option:selected').val();
            this.cal.changeView(pViewTypeGb);

            setRenderRangeText();
        },
        setChangeRange: function(pGb) {
            switch(pGb) {
                case 'today':
                    this.cal.today();
                    break;
                case 'prev':
                    this.cal.prev();
                    break;
                case 'next':
                    this.cal.next();
                    break;
            }

            setRenderRangeText();
        },
        makeCalendarArr: function() {
            var html = [];
            this.calendarArr = [];

            var self = this;
            this.calendarList.data.forEach(function(calendar) {
				if(!isNull(calendar.CAL_SEQ)) {
	                self.addCalendarArr(calendar);

	                if(!isNull(calendar.CAL_SEQ)){
	                    html.push('<div class="lnb-calendars-item"><label>' +
	                            '<input type="checkbox" class="tui-full-calendar-checkbox-round" value="' + (calendar.BONIN_YN == 'Y' ? calendar.CAL_SEQ : 'N' + calendar.CAL_SEQ)  + (calendar.PYOSI_YN=='Y'?'" checked>':'">') +
	                            '<span style="border-color: ' + calendar.CAL_COLOR + '; background-color: ' + calendar.CAL_COLOR + ';"></span>' +
	                            '<span>' + calendar.CAL_NM + '</span>' +
	                            '</label></div>'
	                        );
	                }
				}
            });

            setCalendarArrList(this.calendarArr);
            this.cal.setCalendars(this.calendarArr);
            document.getElementById('calendarList').innerHTML = html.join('\n');
            this.calendarArr.forEach(function(cal) {
                onChangeCalendarsParam(String(cal.id), cal.checked);
            });
        },
        addCalendarArr: function(pCalendar) {
        	if(!isNull(pCalendar.CAL_SEQ)){
                var calendar = {'userId':null, 'id':null, 'name':null, 'checked':true, 'color':null, 'bgColor':null, 'borderColor':null, 'allGongyuYn': null, 'boninYn': null, 'mngYn': null};
                calendar.userId = String(pCalendar.USER_ID);
                calendar.id = pCalendar.BONIN_YN == 'Y' ? String(pCalendar.CAL_SEQ) : 'N' + String(pCalendar.CAL_SEQ);
                calendar.name = pCalendar.CAL_NM;
                calendar.color = '#ffffff';
                calendar.bgColor = pCalendar.CAL_COLOR;
                calendar.dragBgColor = pCalendar.CAL_COLOR;
                calendar.borderColor = pCalendar.CAL_COLOR;
                calendar.checked = pCalendar.PYOSI_YN=='Y'?true:false;
                calendar.allGongyuYn = pCalendar.ALL_GONGYU_YN=='Y'?true:false;
                calendar.boninYn = pCalendar.BONIN_YN=='Y'?true:false;

                this.calendarArr.push(calendar);
        	}
        },
        calModalEntry: function(pId, pData) {	//삭제 confirm 모달 메시지 처리
            var title = '확인';
            var cont = '해당 작업을 수행하시겠습니까?';

            switch(pId) {
	    		case 'ID_CAL_SAVE':
                    title = '저장';
                    cont = '변경 사항을 저장하시겠습니까?';
	    			break;
	    		case 'ID_CAL_DELETE':
	    			title = '삭제';
                    cont = '해당 항목을 삭제하시겠습니까?<br>(해당 캘린더의 스케줄도 삭제됩니다.)';
                    break;
	    	}

	    	this.calModal.openModal('confirm', title, cont, 'small', pId, pData);
	    },
	    calModalCallback: function(pGb, pId, pData) {	//confirm 확인 callback함수 (확인/취소 등 구분값, confirm 호출 구분 값, 전달 데이터)
	    	if(pGb!='confirm') return;

	    	switch(pId) {
	    		case 'ID_CAL_SAVE':
	    			this.saveCalendarRow();
	    			break;
	    		case 'ID_CAL_DELETE':
	    			this.deleteCalendarRow();
	    			break;
	    	}
	    },
    }
});
/*******************************************************************************************************************************************************************
 * vue end
 ********************************************************************************************************************************************************************/

/*******************************************************************************************************************************************************************
 * javascript start
 ********************************************************************************************************************************************************************/
$(document).ready(function(){
// 	editor('codeEditor1', 350);
});

$(function(){
		//탭메뉴
		$(".tab-content").hide();
		$(".tab-content:first").show();
		$(".tab-type04 .tab-inner div a").click(function() {
			$(".tab-type04 .tab-inner div a").removeClass("active");
			$(this).addClass("active");
			$(".tab-content").hide()
			var activeTab = $(this).parent().attr("rel");
			$("#"+activeTab).fadeIn()
		});
});


(function(window, Calendar) {
    var resizeThrottled;
    var useCreationPopup = true;
    var useDetailPopup = true;
    var datePicker, selectedCalendar;

    var ScheduleList = [];

    var SCHEDULE_CATEGORY = [
        'milestone',
        'task'
    ];

    resizeThrottled = tui.util.throttle(function() {
        cal.render();
    }, 50);

    var CalendarList = [];
    var calendarList = document.getElementById('calendarList');
    var calendar;
    var id = 0;

/*
    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'My Calendar';
    calendar.color = '#ffffff';
    calendar.bgColor = '#9e5fff';
    calendar.dragBgColor = '#9e5fff';
    calendar.borderColor = '#9e5fff';
    //alert(JSON.stringify(calendar));
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'Company';
    calendar.color = '#ffffff';
    calendar.bgColor = '#00a9ff';
    calendar.dragBgColor = '#00a9ff';
    calendar.borderColor = '#00a9ff';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'Family';
    calendar.color = '#ffffff';
    calendar.bgColor = '#ff5583';
    calendar.dragBgColor = '#ff5583';
    calendar.borderColor = '#ff5583';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'Friend';
    calendar.color = '#ffffff';
    calendar.bgColor = '#03bd9e';
    calendar.dragBgColor = '#03bd9e';
    calendar.borderColor = '#03bd9e';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'Travel';
    calendar.color = '#ffffff';
    calendar.bgColor = '#bbdc00';
    calendar.dragBgColor = '#bbdc00';
    calendar.borderColor = '#bbdc00';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'etc';
    calendar.color = '#ffffff';
    calendar.bgColor = '#9d9d9d';
    calendar.dragBgColor = '#9d9d9d';
    calendar.borderColor = '#9d9d9d';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'Birthdays';
    calendar.color = '#ffffff';
    calendar.bgColor = '#ffbb3b';
    calendar.dragBgColor = '#ffbb3b';
    calendar.borderColor = '#ffbb3b';
    addCalendar(calendar);

    calendar = new CalendarInfo();
    id += 1;
    calendar.id = String(id);
    calendar.name = 'National Holidays';
    calendar.color = '#ffffff';
    calendar.bgColor = '#ff4040';
    calendar.dragBgColor = '#ff4040';
    calendar.borderColor = '#ff4040';
    addCalendar(calendar);

*/
    var html = [];
    CalendarList.forEach(function(calendar) {
        html.push('<div class="lnb-calendars-item"><label>' +
            '<input type="checkbox" class="tui-full-calendar-checkbox-round" value="' + calendar.boninYn ? String(calendar.id) : 'N' + String(calendar.id) + '" checked>' +
            '<span style="border-color: ' + calendar.borderColor + '; background-color: ' + calendar.borderColor + ';"></span>' +
            '<span>' + calendar.name + '</span>' +
            '</label></div>'
        );
    });
    calendarList.innerHTML = html.join('\n');

    vm.cal = new Calendar('#calendar', {
        defaultView: 'month',
        useCreationPopup: useCreationPopup,
        useDetailPopup: useDetailPopup,
        calendars: CalendarList,
        template: {
            milestone: function(model) {
                return '<span class="calendar-font-icon ic-milestone-b"></span> <span style="background-color: ' + model.bgColor + '">' + model.title + '</span>';
            },
            allday: function(schedule) {
                return getTimeTemplate(schedule, true);
            },
            time: function(schedule) {
                return getTimeTemplate(schedule, false);
            },
            popupDetailRepeat: function(schedule) {
                return 'Repeat : ' + schedule.recurrenceRule;
            }
        }
    });

    window.cal = vm.cal;


    // event handlers
    cal.on({
        'clickMore': function(e) {
        },
        'clickSchedule': function(e) {
        },
        'clickDayname': function(date) {
        },
        'beforeCreateSchedule': function(e) {
        	let cnt = 0;

        	if(!isNull(globalParam.FIXED_USER_ID)) {
    			_.forEach(_.filter(vm.calendarList.data, {'USER_ID': globalParam.FIXED_USER_ID}), function(obj, index) {
    				if(!isNull(obj.CAL_SEQ)) {
    					cnt ++;
    				}
    			});
        	}else {
        		_.forEach(_.filter(vm.calendarList.data, {'USER_ID': vm.session.INTERNAL_ID}), function(obj, index) {
    				if(!isNull(obj.CAL_SEQ)) {
    					cnt ++;
    				}
    			});
        	}

        	if(!isNull(e.calendarId) && cnt > 0){
                vm.createScheduleData(e);
                saveNewSchedule(e);                     //move to callback
        	}else{
				notifySubmit('warning', '캘린더 추가', '일정을 추가하기 위해 캘린더를 먼저 추가해주세요.', 'icon-caution');
        	}
        },
        'beforeUpdateSchedule': function(e) {
            e.schedule.start = e.start;
            e.schedule.end = e.end;


            vm.updateScheduleData(e.schedule.id, e.schedule.calendarId, e.schedule);

        },
        'beforeDeleteSchedule': function(e) {
            vm.deleteScheduleData(e.schedule.id, e.schedule.calendarId);
        },
        'afterRenderSchedule': function(e) {
            var schedule = e.schedule;
            // var element = cal.getElement(schedule.id, schedule.calendarId);
        },
        'clickTimezonesCollapseBtn': function(timezonesCollapsed) {

            if (timezonesCollapsed) {
                cal.setTheme({
                    'week.daygridLeft.width': '77px',
                    'week.timegridLeft.width': '77px'
                });
            } else {
                cal.setTheme({
                    'week.daygridLeft.width': '60px',
                    'week.timegridLeft.width': '60px'
                });
            }

            return true;
        }
    });

    setDropdownCalendarType();
    setRenderRangeText();
    setSchedules();
    setEventListener();


    document.getElementById('calendar').addEventListener('keydown', function(e) {
    });

    /**
     * Get time template for time and all-day
     * @param {Schedule} schedule - schedule
     * @param {boolean} isAllDay - isAllDay or hasMultiDates
     * @returns {string}
     */
    function getTimeTemplate(schedule, isAllDay) {
        var html = [];
        var start = moment(schedule.start.toUTCString());

        if (!isAllDay) {
            html.push('<strong>' + start.format('HH:mm') + '</strong> ');
        }
        if (schedule.isPrivate) {
            html.push('<span class="calendar-font-icon ic-lock-b"></span>');
            html.push(' Private');
        } else {
            if (schedule.isReadOnly) {
                html.push('<span class="calendar-font-icon ic-readonly-b"></span>');
            } else if (schedule.recurrenceRule) {
                html.push('<span class="calendar-font-icon ic-repeat-b"></span>');
            } else if (schedule.attendees.length) {
                html.push('<span class="calendar-font-icon ic-user-b"></span>');
            } else if (schedule.location) {
                html.push('<span class="calendar-font-icon ic-location-b"></span>');
            }
            html.push(' ' + schedule.title);
        }

        return html.join('');
    }

    /**
     * A listener for click the menu
     * @param {Event} e - click event
     */
    function onClickMenu(e) {
        var target = $(e.target).closest('a[role="menuitem"]')[0];
        var action = getDataAction(target);
        var options = cal.getOptions();
        var viewName = '';

        switch (action) {
            case 'toggle-daily':
                viewName = 'day';
                break;
            case 'toggle-weekly':
                viewName = 'week';
                break;
            case 'toggle-monthly':
                options.month.visibleWeeksCount = 0;
                viewName = 'month';
                break;
            case 'toggle-weeks2':
                options.month.visibleWeeksCount = 2;
                viewName = 'month';
                break;
            case 'toggle-weeks3':
                options.month.visibleWeeksCount = 3;
                viewName = 'month';
                break;
            case 'toggle-narrow-weekend':
                options.month.narrowWeekend = !options.month.narrowWeekend;
                options.week.narrowWeekend = !options.week.narrowWeekend;
                viewName = cal.getViewName();

                target.querySelector('input').checked = options.month.narrowWeekend;
                break;
            case 'toggle-start-day-1':
                options.month.startDayOfWeek = options.month.startDayOfWeek ? 0 : 1;
                options.week.startDayOfWeek = options.week.startDayOfWeek ? 0 : 1;
                viewName = cal.getViewName();

                target.querySelector('input').checked = options.month.startDayOfWeek;
                break;
            case 'toggle-workweek':
                options.month.workweek = !options.month.workweek;
                options.week.workweek = !options.week.workweek;
                viewName = cal.getViewName();

                target.querySelector('input').checked = !options.month.workweek;
                break;
            default:
                break;
        }

        cal.setOptions(options, true);
        cal.changeView(viewName, true);

        setDropdownCalendarType();
        setRenderRangeText();
        setSchedules();
    }

    function onClickNavi(e) {
        var action = getDataAction(e.target);

        switch (action) {
            case 'move-prev':
                cal.prev();
                break;
            case 'move-next':
                cal.next();
                break;
            case 'move-today':
                cal.today();
                break;
            default:
                return;
        }

        setRenderRangeText();
        setSchedules();
    }

    function onNewSchedule() {
        var title = $('#new-schedule-title').val();
        var location = $('#new-schedule-location').val();
        var isAllDay = document.getElementById('new-schedule-allday').checked;
        var start = datePicker.getStartDate();
        var end = datePicker.getEndDate();
        var calendar = selectedCalendar ? selectedCalendar : CalendarList[0];


//         alert(start);
        if (!title) {
            return;
        }

        cal.createSchedules([{
            id: String(chance.guid()),
            calendarId: calendar.id,
            title: title,
            isAllDay: isAllDay,
            start: start,
            end: end,
            category: isAllDay ? 'allday' : 'time',
            dueDateClass: '',
            color: calendar.color,
            bgColor: calendar.bgColor,
            dragBgColor: calendar.bgColor,
            borderColor: calendar.borderColor,
            raw: {
                location: location
            },
            state: 'Busy'
        }]);

        $('#modal-new-schedule').modal('hide');
    }

    function onChangeNewScheduleCalendar(e) {
        var target = $(e.target).closest('a[role="menuitem"]')[0];
        var calendarId = getDataAction(target);
        changeNewScheduleCalendar(calendarId);
    }

    function changeNewScheduleCalendar(calendarId) {
        var calendarNameElement = document.getElementById('calendarName');
        var calendar = findUserCalendar(vm.userId, calendarId);
        var html = [];

        html.push('<span class="calendar-bar" style="background-color: ' + calendar.bgColor + '; border-color:' + calendar.borderColor + ';"></span>');
        html.push('<span class="calendar-name">' + calendar.name + '</span>');

        calendarNameElement.innerHTML = html.join('');

        selectedCalendar = calendar;
    }

    function createNewSchedule(event) {
        var start = event.start ? new Date(event.start.getTime()) : new Date();
        var end = event.end ? new Date(event.end.getTime()) : moment().add(1, 'hours').toDate();

        if (useCreationPopup) {
            cal.openCreationPopup({
                start: start,
                end: end
            });
        }
    }
    function saveNewSchedule(scheduleData) {
        var calendar = scheduleData.calendar || findUserCalendar(vm.userId, scheduleData.calendarId);

        var schedule = {
            id: String(chance.guid()),
            title: scheduleData.title,
            isAllDay: scheduleData.isAllDay,
            start: scheduleData.start,
            end: scheduleData.end,
            category: scheduleData.isAllDay ? 'allday' : 'time',
            dueDateClass: '',
            color: calendar.color,
            bgColor: calendar.bgColor,
            dragBgColor: calendar.bgColor,
            borderColor: calendar.borderColor,
            location: scheduleData.location,
            raw: {
                //class: scheduleData.raw['class']
            },
            state: scheduleData.state
        };
        if (calendar) {
            schedule.calendarId = calendar.id;
            schedule.color = calendar.color;
            schedule.bgColor = calendar.bgColor;
            schedule.borderColor = calendar.borderColor;
        }

        cal.createSchedules([schedule]);

        refreshScheduleVisibility();
    }

    function onChangeCalendars(e) {
        var calendarId = e.target.value;
        var checked = e.target.checked;
        var viewAll = document.querySelector('#$lnb-calendars-item input');
        var calendarElements = Array.prototype.slice.call(document.querySelectorAll('#calendarList input'));
        var allCheckedCalendars = true;

        if (calendarId === 'all') {
            allCheckedCalendars = checked;

            calendarElements.forEach(function(input) {
                var span = input.parentNode;
                input.checked = checked;
                span.style.backgroundColor = checked ? span.style.borderColor : 'transparent';
            });

            CalendarList.forEach(function(calendar) {
                calendar.checked = checked;
            });
        } else {
            findCalendar(calendarId).checked = checked;

            allCheckedCalendars = calendarElements.every(function(input) {
                return input.checked;
            });

            if (allCheckedCalendars) {
                viewAll.checked = true;
            } else {
                viewAll.checked = false;
            }
        }

        refreshScheduleVisibility();
    }

    function onChangeCalendarsParam(pCalendarId, pChecked) {        /////////////////////
        //debugger
        var calendarId = pCalendarId;
        var checked = pChecked;
        var viewAll = document.querySelector('.lnb-calendars-item input');
        var calendarElements = Array.prototype.slice.call(document.querySelectorAll('#calendarList input'));
        var allCheckedCalendars = true;

        if (calendarId === 'all') {
            allCheckedCalendars = checked;

            calendarElements.forEach(function(input) {
                var span = input.parentNode;
                input.checked = checked;
                span.style.backgroundColor = checked ? span.style.borderColor : 'transparent';
            });

            CalendarList.forEach(function(calendar) {
                calendar.checked = checked;
            });
        } else {
            findUserCalendar(vm.userId, calendarId).checked = checked;

            allCheckedCalendars = calendarElements.every(function(input) {
                return input.checked;
            });

            if (allCheckedCalendars) {
                viewAll.checked = true;
            } else {
                viewAll.checked = false;
            }
        }

        refreshScheduleVisibility();
    }
    window.onChangeCalendarsParam = onChangeCalendarsParam;

    function refreshScheduleVisibility() {
        var calendarElements = Array.prototype.slice.call(document.querySelectorAll('#calendarList input'));

        CalendarList.forEach(function(calendar) {
            cal.toggleSchedules(calendar.id, !calendar.checked, false);
        });

        cal.render(true);

        calendarElements.forEach(function(input) {
            var span = input.nextElementSibling;
            span.style.backgroundColor = input.checked ? span.style.borderColor : 'transparent';
        });
    }
    window.refreshScheduleVisibility = refreshScheduleVisibility;


    function setDropdownCalendarType() {
        var calendarTypeName = document.getElementById('calendarTypeName');
        var calendarTypeIcon = document.getElementById('calendarTypeIcon');
        var options = cal.getOptions();
        var type = cal.getViewName();
        var iconClassName;

        if (type === 'day') {
            type = 'Daily';
            iconClassName = 'calendar-icon ic_view_day';
        } else if (type === 'week') {
            type = 'Weekly';
            iconClassName = 'calendar-icon ic_view_week';
        } else if (options.month.visibleWeeksCount === 2) {
            type = '2 weeks';
            iconClassName = 'calendar-icon ic_view_week';
        } else if (options.month.visibleWeeksCount === 3) {
            type = '3 weeks';
            iconClassName = 'calendar-icon ic_view_week';
        } else {
            type = 'Monthly';
            iconClassName = 'calendar-icon ic_view_month';
        }

        calendarTypeName.innerHTML = type;
        calendarTypeIcon.className = iconClassName;
    }


    function setRenderRangeText() {
        var renderRange = document.getElementById('renderRange');
        var options = cal.getOptions();
        var viewName = cal.getViewName();
        var html = [];
        if (viewName === 'day') {
            html.push(moment(cal.getDate().getTime()).format('YYYY.MM.DD'));
        } else if (viewName === 'month' &&
            (!options.month.visibleWeeksCount || options.month.visibleWeeksCount > 4)) {
            html.push(moment(cal.getDate().getTime()).format('YYYY.MM'));
        } else {
            html.push(moment(cal.getDateRangeStart().getTime()).format('YYYY.MM.DD'));
            html.push(' ~ ');
            html.push(moment(cal.getDateRangeEnd().getTime()).format(' MM.DD'));
        }

        renderRange.innerHTML = html.join('');
    }
    window.setRenderRangeText = setRenderRangeText;


    function setSchedules() {
        cal.clear();
//         generateSchedule(cal.getViewName(), cal.getDateRangeStart(), cal.getDateRangeEnd());
        cal.createSchedules(ScheduleList);
        // var schedules = [
        //     {id: 489273, title: 'Workout for 2018-08-17', isAllDay: false, start: '2018-09-06T10:00+09:00', end: '2018-09-06T14:00:00+09:00', goingDuration: 30, comingDuration: 30, color: '#ffffff', isVisible: true, bgColor: '#69BB2D', dragBgColor: '#69BB2D', borderColor: '#69BB2D', calendarId: 'logged-workout', category: 'time', dueDateClass: '', customStyle: 'cursor: default;', isPending: false, isFocused: false, isReadOnly: true, isPrivate: false, location: '', attendees: '', recurrenceRule: '', state: ''},
        //     {id: 18073, title: 'completed with blocks', isAllDay: false, start: '2018-09-06T09:00:00+09:00', end: '2018-09-06T10:00:00+09:00', color: '#ffffff', isVisible: true, bgColor: '#54B8CC', dragBgColor: '#54B8CC', borderColor: '#54B8CC', calendarId: 'workout', category: 'time', dueDateClass: '', customStyle: '', isPending: false, isFocused: false, isReadOnly: false, isPrivate: false, location: '', attendees: '', recurrenceRule: '', state: ''}
        // ];
        // cal.createSchedules(schedules);
        refreshScheduleVisibility();
    }

    function setSchedulesMyList(schedList) {
        ScheduleList = [];

        cal.clear();
        schedList.forEach(function(sched) {
            var calendar = findUserCalendar(sched.USER_ID, parseInt(sched.CAL_SEQ));

            var schedule = {
                id: calendar.boninYn ? String(sched.ILJEONG_SEQ) : 'N' + String(sched.ILJEONG_SEQ),
                calendarId: calendar.id,
                title: sched.ILJEONG_NM,
                isAllDay: sched.ALLDAY_YN=='Y'?true:false,
                isReadOnly: !calendar.boninYn&&sched.ALL_GONGYU_YN=='Y'?true:false,
                start: new Date(parseInt(sched.FR_DTTM)),
                end: new Date(parseInt(sched.TO_DTTM)),
                category: sched.ALLDAY_YN=='Y'?'allday':'time',
                dueDateClass: '',
                color: calendar.color,
                bgColor: calendar.bgColor,
                dragBgColor: calendar.bgColor,
                borderColor: calendar.borderColor,
                location: sched.LOCATIOIN,
                raw: {
                    //class: scheduleData.raw['class']
                },
                state: ''
            };

            ScheduleList.push(schedule);
        });

        cal.createSchedules(ScheduleList);
        refreshScheduleVisibility();
    }
    window.setSchedulesMyList = setSchedulesMyList;

    function setEventListener() {
        $('#menu-navi').on('click', onClickNavi);
        $('.dropdown-menu a[role="menuitem"]').on('click', onClickMenu);
        $('#lnb-calendars').on('change', onChangeCalendars);

        $('#btn-save-schedule').on('click', onNewSchedule);
        $('#btn-new-schedule').on('click', createNewSchedule);

        $('#dropdownMenu-calendars-list').on('click', onChangeNewScheduleCalendar);

        window.addEventListener('resize', resizeThrottled);
    }

    function getDataAction(target) {
        return target.dataset ? target.dataset.action : target.getAttribute('data-action');
    }


function CalendarInfo() {
    this.id = null;
    this.name = null;
    this.checked = true;
    this.color = null;
    this.bgColor = null;
    this.borderColor = null;
    this.allGongyuYn = null;
    this.boninYn = null;
}

function addCalendar(calendar) {
    CalendarList.push(calendar);
}

function setCalendarList(calendarArr) {
    CalendarList = calendarArr;
}
window.setCalendarArrList = setCalendarList;

/* 기존의 캘린더를 가져오는 함수*/
function findCalendar(id) {
    var found;

    if(isNull(CalendarList)) alert('calendarList is null!!!');

    CalendarList.forEach(function(calendar) {
        if (calendar.id == id) {
            found = calendar;
        }
    });

    return found || CalendarList[0];
}
window.findCalendar = findCalendar;
//사용자, 캘린더 아이디를 통해 가져오는 캘린더
function findUserCalendar(userId, id) {
    var found;

    if(userId != vm.userId){
    	id = 'N' + id.toString();
    }

    if(isNull(CalendarList)) alert('calendarList is null!!!');

    CalendarList.forEach(function(calendar) {
        if (calendar.userId == userId && calendar.id == id) {
            found = calendar;
        }
    });

    return found || CalendarList[0];
}
window.findUserCalendar = findUserCalendar;

function hexToRGBA(hex) {
    var radix = 16;
    var r = parseInt(hex.slice(1, 3), radix),
        g = parseInt(hex.slice(3, 5), radix),
        b = parseInt(hex.slice(5, 7), radix),
        a = parseInt(hex.slice(7, 9), radix) / 255 || 1;
    var rgba = 'rgba(' + r + ', ' + g + ', ' + b + ', ' + a + ')';

    return rgba;
}

function ScheduleInfo() {
    this.id = null;
    this.calendarId = null;

    this.title = null;
    this.body = null;
    this.isAllday = false;
    this.start = null;
    this.end = null;
    this.category = '';
    this.dueDateClass = '';

    this.color = null;
    this.bgColor = null;
    this.dragBgColor = null;
    this.borderColor = null;
    this.customStyle = '';

    this.isFocused = false;
    this.isPending = false;
    this.isVisible = true;
    this.isReadOnly = false;
    this.goingDuration = 0;
    this.comingDuration = 0;
    this.recurrenceRule = '';

    this.raw = {
        memo: '',
        hasToOrCc: false,
        hasRecurrenceRule: false,
        location: null,
        class: 'public', // or 'private'
        creator: {
            name: '',
            avatar: '',
            company: '',
            email: '',
            phone: ''
        }
    };
}

function generateTime(schedule, renderStart, renderEnd) {
    var baseDate = new Date(renderStart);
    var singleday = chance.bool({likelihood: 70});
    var startDate = moment(renderStart.getTime())
    var endDate = moment(renderEnd.getTime());
    var diffDate = endDate.diff(startDate, 'days');

    schedule.isAllday = chance.bool({likelihood: 30});
    if (schedule.isAllday) {
        schedule.category = 'allday';
    } else if (chance.bool({likelihood: 30})) {
        schedule.category = SCHEDULE_CATEGORY[chance.integer({min: 0, max: 1})];
        if (schedule.category === SCHEDULE_CATEGORY[1]) {
            schedule.dueDateClass = 'morning';
        }
    } else {
        schedule.category = 'time';
    }

    startDate.add(chance.integer({min: 0, max: diffDate}), 'days');
    startDate.hours(chance.integer({min: 0, max: 23}))
    startDate.minutes(chance.bool() ? 0 : 30);
    schedule.start = startDate.toDate();

    endDate = moment(startDate);
    if (schedule.isAllday) {
        endDate.add(chance.integer({min: 0, max: 3}), 'days');
    }

    schedule.end = endDate
        .add(chance.integer({min: 1, max: 4}), 'hour')
        .toDate();

    if (!schedule.isAllday && chance.bool({likelihood: 20})) {
        schedule.goingDuration = chance.integer({min: 30, max: 120});
        schedule.comingDuration = chance.integer({min: 30, max: 120});;

        if (chance.bool({likelihood: 50})) {
            schedule.end = schedule.start;
        }
    }
}

function generateNames() {
    var names = [];
    var i = 0;
    var length = chance.integer({min: 1, max: 10});

    for (; i < length; i += 1) {
        names.push(chance.name());
    }

    return names;
}

function generateRandomSchedule(calendar, renderStart, renderEnd) {
    var schedule = new ScheduleInfo();

    schedule.id = chance.guid();
    schedule.calendarId = calendar.id;

    schedule.title = chance.sentence({words: 3});
    schedule.body = chance.bool({likelihood: 20}) ? chance.sentence({words: 10}) : '';
    schedule.isReadOnly = chance.bool({likelihood: 20});
    generateTime(schedule, renderStart, renderEnd);

    schedule.isPrivate = chance.bool({likelihood: 10});
    schedule.location = chance.address();
    schedule.attendees = chance.bool({likelihood: 70}) ? generateNames() : [];
    schedule.recurrenceRule = chance.bool({likelihood: 20}) ? 'repeated events' : '';

    schedule.color = calendar.color;
    schedule.bgColor = calendar.bgColor;
    schedule.dragBgColor = calendar.dragBgColor;
    schedule.borderColor = calendar.borderColor;

    if (schedule.category === 'milestone') {
        schedule.color = schedule.bgColor;
        schedule.bgColor = 'transparent';
        schedule.dragBgColor = 'transparent';
        schedule.borderColor = 'transparent';
    }

    schedule.raw.memo = chance.sentence();
    schedule.raw.creator.name = chance.name();
    schedule.raw.creator.avatar = chance.avatar();
    schedule.raw.creator.company = chance.company();
    schedule.raw.creator.email = chance.email();
    schedule.raw.creator.phone = chance.phone();

    ScheduleList.push(schedule);
}

function generateSchedule(viewName, renderStart, renderEnd) {
    ScheduleList = [];

    CalendarList.forEach(function(calendar) {
        var i = 0, length = 10;
        if (viewName === 'month') {
            length = 3;
        } else if (viewName === 'day') {
            length = 4;
        }
        for (; i < length; i += 1) {
            generateRandomSchedule(calendar, renderStart, renderEnd);
        }
    });
}
cal.render();
})(window, tui.Calendar);

function editor(id, height) {
    var target = document.getElementById(id);
    var myCodeMirror = CodeMirror.fromTextArea(target, {
        mode: "javascript",
        theme: "neo",
        lineNumbers: true,
        readOnly: true
    });

    myCodeMirror.setSize(null, height);
}
/*******************************************************************************************************************************************************************
 * javascript end
 ********************************************************************************************************************************************************************/
</script>

